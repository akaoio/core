<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Living Agent Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            min-width: 100px;
        }
        
        .status-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .status-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .team-grid {
            display: grid;
            gap: 15px;
        }
        
        .team-card {
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .team-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .team-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .team-name {
            font-weight: bold;
            color: #667eea;
            text-transform: uppercase;
            font-size: 14px;
        }
        
        .team-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #e8f5e8;
            color: #2d7d2d;
        }
        
        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }
        
        .agent-item.running {
            border-left-color: #28a745;
            background: #e8f5e8;
        }
        
        .agent-item.busy {
            border-left-color: #ffc107;
            background: #fff8e1;
        }
        
        .agent-item.offline {
            border-left-color: #dc3545;
            background: #f8e8e8;
        }
        
        .agent-info {
            display: flex;
            flex-direction: column;
        }
        
        .agent-name {
            font-weight: 500;
            font-size: 13px;
            color: #333;
        }
        
        .agent-role {
            font-size: 11px;
            color: #666;
            text-transform: capitalize;
        }
        
        .agent-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.running { background: #28a745; }
        .status-dot.busy { background: #ffc107; }
        .status-dot.idle { background: #6c757d; }
        .status-dot.offline { background: #dc3545; }
        
        .activity-panel {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-time {
            font-size: 11px;
            color: #6c757d;
            min-width: 60px;
        }
        
        .activity-agent {
            font-weight: 500;
            color: #667eea;
            min-width: 100px;
            font-size: 12px;
        }
        
        .activity-message {
            flex: 1;
            font-size: 13px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .task-queue {
            margin-top: 15px;
        }
        
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #e3f2fd;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .queue-priority {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .priority-high { background: #ffebee; color: #c62828; }
        .priority-medium { background: #fff8e1; color: #ef6c00; }
        .priority-low { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Living Agent Dashboard</h1>
        <p>Real-time Air-based Multi-Agent System Monitor</p>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-number" id="total-agents">0</div>
                <div class="status-label">Total Agents</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="active-agents">0</div>
                <div class="status-label">Active</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="busy-agents">0</div>
                <div class="status-label">Busy</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="task-queue-size">0</div>
                <div class="status-label">Queued Tasks</div>
            </div>
        </div>
    </div>
    
    <div class="connection-status" id="connection-status">
        üîÑ Connecting to Air...
    </div>
    
    <div class="dashboard">
        <div class="panel">
            <h2>üè¢ Team Overview</h2>
            <div class="team-grid" id="team-grid">
                <div class="loading">
                    <div class="pulse">üîÑ Loading teams...</div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>‚ö° Live Activity Feed</h2>
            <div class="activity-panel" id="activity-feed">
                <div class="loading">
                    <div class="pulse">üì° Waiting for agent activity...</div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìä System Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="messages-per-minute">0</div>
                    <div class="metric-label">Messages/Min</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-response-time">0ms</div>
                    <div class="metric-label">Avg Response Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="success-rate">100%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="uptime">0m</div>
                    <div class="metric-label">System Uptime</div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìã Task Queue Monitor</h2>
            <div id="task-queue-monitor">
                <div class="loading">
                    <div class="pulse">‚è≥ Loading task queue...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard JavaScript for real-time updates via Air/GUN
        class LiveAgentDashboard {
            constructor() {
                this.gun = Gun(['http://localhost:8765/gun'])
                this.agents = new Map()
                this.teams = new Map()
                this.activity = []
                this.metrics = {
                    messagesPerMinute: 0,
                    avgResponseTime: 0,
                    successRate: 100,
                    uptime: Date.now()
                }
                
                this.init()
            }
            
            init() {
                console.log('üöÄ Initializing Living Agent Dashboard...')
                this.setupGunListeners()
                this.startMetricsCollection()
                this.updateConnectionStatus(true)
                
                // Update dashboard every second
                setInterval(() => this.updateDashboard(), 1000)
            }
            
            setupGunListeners() {
                // Listen for agent registrations
                this.gun.get('agents').map().on((data, key) => {
                    if (data && data.config) {
                        this.updateAgent(data)
                    }
                })
                
                // Listen for system launcher status
                this.gun.get('system/launcher_status').on((data) => {
                    if (data) {
                        this.updateSystemStatus(data)
                    }
                })
                
                // Listen for dashboard updates
                this.gun.get('dashboard').on((data) => {
                    if (data) {
                        this.updateDashboardMetrics(data)
                    }
                })
                
                // Listen for task queue updates
                this.gun.get('task_queue').map().on((data, key) => {
                    if (data) {
                        this.updateTaskQueue(data)
                    }
                })
                
                // Listen for activity logs
                this.gun.get('logs/activity').on((data) => {
                    if (data) {
                        this.addActivity(data)
                    }
                })
                
                console.log('üì° GUN listeners setup complete')
            }
            
            updateAgent(agentData) {
                const agentId = agentData.config.instanceId
                this.agents.set(agentId, {
                    ...agentData,
                    lastSeen: Date.now()
                })
                
                // Group by team
                const teamId = agentData.config.teamId
                if (!this.teams.has(teamId)) {
                    this.teams.set(teamId, {
                        id: teamId,
                        agents: [],
                        runningCount: 0
                    })
                }
                
                const team = this.teams.get(teamId)
                const existingIndex = team.agents.findIndex(a => a.instanceId === agentId)
                
                if (existingIndex >= 0) {
                    team.agents[existingIndex] = agentData
                } else {
                    team.agents.push(agentData)
                }
                
                team.runningCount = team.agents.filter(a => a.status === 'active' || a.status === 'busy').length
            }
            
            updateSystemStatus(statusData) {
                console.log('üìä System status update:', statusData)
                
                // Update status bar
                document.getElementById('total-agents').textContent = statusData.total_agents || 0
                document.getElementById('active-agents').textContent = statusData.running_agents || 0
                
                // Calculate busy agents
                let busyCount = 0
                this.agents.forEach(agent => {
                    if (agent.status === 'busy') busyCount++
                })
                document.getElementById('busy-agents').textContent = busyCount
            }
            
            updateDashboardMetrics(dashboardData) {
                if (dashboardData.metrics) {
                    this.metrics = { ...this.metrics, ...dashboardData.metrics }
                }
            }
            
            updateTaskQueue(taskData) {
                // Count pending tasks
                const pendingTasks = Object.values(taskData).filter(task => 
                    task.status === 'pending' || task.status === 'in_progress'
                ).length
                
                document.getElementById('task-queue-size').textContent = pendingTasks
            }
            
            addActivity(activityData) {
                this.activity.unshift({
                    ...activityData,
                    timestamp: Date.now()
                })
                
                // Keep only last 50 activities
                if (this.activity.length > 50) {
                    this.activity = this.activity.slice(0, 50)
                }
                
                this.renderActivityFeed()
            }
            
            updateDashboard() {
                this.renderTeamGrid()
                this.renderActivityFeed()
                this.renderMetrics()
                this.renderTaskQueue()
                
                // Update uptime
                const uptime = Math.floor((Date.now() - this.metrics.uptime) / 60000)
                document.getElementById('uptime').textContent = `${uptime}m`
            }
            
            renderTeamGrid() {
                const teamGrid = document.getElementById('team-grid')
                if (!teamGrid) return
                
                if (this.teams.size === 0) {
                    teamGrid.innerHTML = '<div class="loading"><div class="pulse">üîÑ No teams detected...</div></div>'
                    return
                }
                
                let html = ''
                this.teams.forEach(team => {
                    html += `
                        <div class="team-card">
                            <div class="team-header">
                                <div class="team-name">${team.id}</div>
                                <div class="team-status">${team.runningCount}/${team.agents.length} active</div>
                            </div>
                            <div class="agent-list">
                                ${team.agents.map(agent => this.renderAgentItem(agent)).join('')}
                            </div>
                        </div>
                    `
                })
                
                teamGrid.innerHTML = html
            }
            
            renderAgentItem(agent) {
                const statusClass = this.getAgentStatusClass(agent.status)
                const timeSinceHeartbeat = Date.now() - (agent.heartbeat || 0)
                const isOnline = timeSinceHeartbeat < 30000 // 30 seconds
                
                return `
                    <div class="agent-item ${statusClass}">
                        <div class="agent-info">
                            <div class="agent-name">${agent.config?.instanceId || 'Unknown'}</div>
                            <div class="agent-role">${agent.config?.role || 'Unknown'}</div>
                        </div>
                        <div class="agent-status">
                            <div class="status-dot ${isOnline ? agent.status : 'offline'}"></div>
                            <span>${isOnline ? agent.status : 'offline'}</span>
                        </div>
                    </div>
                `
            }
            
            getAgentStatusClass(status) {
                switch (status) {
                    case 'active': return 'running'
                    case 'busy': return 'busy'
                    case 'idle': return 'running'
                    default: return 'offline'
                }
            }
            
            renderActivityFeed() {
                const feed = document.getElementById('activity-feed')
                if (!feed || this.activity.length === 0) return
                
                const html = this.activity.map(activity => {
                    const time = new Date(activity.timestamp).toLocaleTimeString()
                    return `
                        <div class="activity-item">
                            <div class="activity-time">${time}</div>
                            <div class="activity-agent">${activity.agent || 'System'}</div>
                            <div class="activity-message">${activity.message || 'Activity update'}</div>
                        </div>
                    `
                }).join('')
                
                feed.innerHTML = html
            }
            
            renderMetrics() {
                document.getElementById('messages-per-minute').textContent = this.metrics.messagesPerMinute
                document.getElementById('avg-response-time').textContent = `${this.metrics.avgResponseTime}ms`
                document.getElementById('success-rate').textContent = `${Math.round(this.metrics.successRate)}%`
            }
            
            renderTaskQueue() {
                // This would render the task queue monitor
                const monitor = document.getElementById('task-queue-monitor')
                if (!monitor) return
                
                // Placeholder implementation
                monitor.innerHTML = '<div class="loading"><div class="pulse">üìã Task queue monitoring active...</div></div>'
            }
            
            startMetricsCollection() {
                // Simulate metrics collection
                setInterval(() => {
                    this.metrics.messagesPerMinute = Math.floor(Math.random() * 50)
                    this.metrics.avgResponseTime = Math.floor(Math.random() * 500) + 100
                    this.metrics.successRate = 95 + Math.random() * 5
                }, 5000)
            }
            
            updateConnectionStatus(connected) {
                const status = document.getElementById('connection-status')
                if (!status) return
                
                if (connected) {
                    status.textContent = 'üü¢ Connected to Air'
                    status.className = 'connection-status connected'
                } else {
                    status.textContent = 'üî¥ Disconnected from Air'
                    status.className = 'connection-status disconnected'
                }
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new LiveAgentDashboard()
        })
    </script>
</body>
</html>